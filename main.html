<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏° AI Response</title>
  <link rel="icon" type="image/png" href="solvely.png" />
  <link rel="stylesheet" href="main.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/gh/mattdiamond/Recorderjs@master/dist/recorder.js" defer></script>
  <script>
    if (sessionStorage.getItem("authenticated") !== "true") {
      window.location.href = "/";
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="selected-language" id="selectedLanguageDisplay"></div>
    <h1>Ordering Food (Tap to Record)</h1>
    <div class="record-section">
      <button id="recordBtn" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á">
        <span class="material-icons" id="micIcon">mic</span>
      </button>
      <div id="recordStatus" class="record-status"></div>
    </div>
    <audio id="audioPlayer" controls style="display:none; margin-top: 15px;"></audio>
    <div class="results">
      <h2>Transcribed Text:</h2>
      <pre id="transcribedText" class="transcribed-text"></pre>
      <h2>AI Response:</h2>
      <div id="aiResponseContainer" class="ai-response"></div>
    </div>
    <div id="menuImageContainer" style="margin-top: 20px;">
      <h2>Menu Detech:</h2>
      <img id="menuImage" src="" alt="‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£" style="max-width: 300px; display: none; border-radius: 10px;" />
    </div>
    <button class="send-order-btn">Send Order</button>
    <button class="reset-chat-btn" onclick="resetChat()">‚ôªÔ∏è Reset ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
  </div>

<script>
const defaultURL = "https://app.solvelysaid.space/";
const fallbackURL = "https://solvelysaidbn.onrender.com";
let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;

async function checkServer(url) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 3000);
  try {
    const res = await fetch(url + "/ping", { method: "GET", signal: controller.signal });
    clearTimeout(timeoutId);
    if (res.ok) {
      sessionStorage.setItem("workingBaseURL", url);
      baseURL = url;
      return true;
    }
  } catch {
    clearTimeout(timeoutId);
    return false;
  }
}

(async () => {
  const ok = await checkServer(baseURL);
  if (!ok) {
    const fallbackOk = await checkServer(fallbackURL);
    if (!fallbackOk) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÉ‡∏î‡πÜ ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢");
    }
  }
})();
</script>

<script>
const langMap = {
  th: { name: "Thai", flag: "https://flagcdn.com/w40/th.png" },
  en: { name: "English", flag: "https://flagcdn.com/w40/gb.png" }
};
const selectedLangCode = localStorage.getItem('selectedLanguage') || 'th';
const selectedLang = langMap[selectedLangCode] || langMap['th'];
document.getElementById('selectedLanguageDisplay').innerHTML = `<img src="${selectedLang.flag}" alt="${selectedLang.name} Flag" /> ${selectedLang.name}`;

const recordBtn = document.getElementById("recordBtn");
const micIcon = document.getElementById("micIcon");
const recordStatus = document.getElementById("recordStatus");
const audioPlayer = document.getElementById("audioPlayer");

let recorder;
let gumStream;
let isRecording = false;
let silenceTimeout;
let maxRecordingDuration = 10000; // ‚è±Ô∏è ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
let maxDurationTimeout;
const silenceLimit = 5000;       // üîá ‡∏ñ‡πâ‡∏≤‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
const silenceThreshold = 0.01;

recordBtn.addEventListener("click", () => {
  if (!isRecording) {
    startRecording();
  } else {
    stopRecording();
  }
});

function monitorSilence(audioContext, source) {
  const analyser = audioContext.createAnalyser();
  analyser.fftSize = 2048;
  const dataArray = new Uint8Array(analyser.fftSize);
  source.connect(analyser);

  const checkSilence = () => {
    analyser.getByteTimeDomainData(dataArray);
    const rms = Math.sqrt(
      dataArray.reduce((sum, val) => {
        const norm = (val - 128) / 128;
        return sum + norm * norm;
      }, 0) / dataArray.length
    );

    if (rms < silenceThreshold) {
      if (!silenceTimeout) {
        silenceTimeout = setTimeout(() => {
          console.log("üîï ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥ ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î");
          stopRecording();
        }, silenceLimit);
      }
    } else {
      clearTimeout(silenceTimeout);
      silenceTimeout = null;
    }

    if (isRecording) requestAnimationFrame(checkSilence);
  };

  checkSilence();
}

function startRecording() {
  navigator.mediaDevices.getUserMedia({
    audio: {
      noiseSuppression: true,
      echoCancellation: true,
      autoGainControl: true
    }
  }).then(stream => {
    gumStream = stream;
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const input = audioContext.createMediaStreamSource(stream);
    recorder = new Recorder(input, { numChannels: 1 });

    recorder.record();
    isRecording = true;

    monitorSilence(audioContext, input);

    maxDurationTimeout = setTimeout(() => {
      console.log("‚è±Ô∏è ‡∏Ñ‡∏£‡∏ö 10 ‡∏ß‡∏¥ ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á");
      stopRecording();
    }, maxRecordingDuration);

    recordStatus.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
    recordBtn.classList.add("recording");
    micIcon.textContent = "stop";
  }).catch(err => {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô: " + err.message);
  });
}

function stopRecording() {
  if (!recorder) return;

  recorder.stop();
  gumStream.getAudioTracks()[0].stop();
  clearTimeout(silenceTimeout);
  clearTimeout(maxDurationTimeout);
  silenceTimeout = null;

  recorder.exportWAV(blob => {
    const audioUrl = URL.createObjectURL(blob);
    audioPlayer.src = audioUrl;
    audioPlayer.style.display = "block";

    const formData = new FormData();
    formData.append("file", blob, "recorded_audio.wav");
    formData.append("language", selectedLangCode);

    fetch(`${baseURL}/upload`, {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(result => {
      document.getElementById("transcribedText").textContent = result.text || "";
      const aiResponseDiv = document.getElementById("aiResponseContainer");
      aiResponseDiv.textContent = result.chat_response || "";

      if (result.menu) {
        const menuImg = document.getElementById("menuImage");
        menuImg.src = `${baseURL}/image/${encodeURIComponent(result.menu)}`;
        menuImg.alt = result.menu;
        menuImg.style.display = "block";
      } else {
        document.getElementById("menuImage").style.display = "none";
      }
    })
    .catch(() => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ"));

    recordStatus.textContent = "";
    recordBtn.classList.remove("recording");
    micIcon.textContent = "mic";
    isRecording = false;
  });
}

function resetChat() {
  fetch(`${baseURL}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: "reset" })
  })
  .then(res => res.json())
  .then(result => {
    alert(result.response || "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
    document.getElementById("transcribedText").textContent = "reset";
    document.getElementById("aiResponseContainer").textContent = result.response || "";
    document.getElementById("menuImage").style.display = "none";
  })
  .catch(() => {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
  });
}
</script>
</body>
</html>
