<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบบันทึกเสียง พร้อม AI Response</title>
  <link rel="icon" type="image/png" href="solvely.png" />
  <link rel="stylesheet" href="main.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    .flags-multilang {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      justify-content: center;
    }
    .flag-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f8f9fb;
      border-radius: 8px;
      padding: 3px 12px;
      font-size: 1em;
      box-shadow: 0 1px 6px #eee;
      cursor: pointer;
      transition: background 0.18s;
    }
    .flag-item.selected,
    .flag-item:hover {
      background: #e0eaff;
    }
    .flag-item img {
      width: 28px;
      border-radius: 5px;
    }
  </style>
  <script>
    const isAuthenticated = sessionStorage.getItem("authenticated") === "true";
    const isLocal = [
      'localhost',
      '127.0.0.1',
      '::1'
    ].includes(window.location.hostname) ||
    window.location.protocol === 'file:';

    if (!isAuthenticated && !isLocal) {
      window.location.href = "/";
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="selected-language" id="selectedLanguageDisplay"></div>
    <!-- เตรียม div สำหรับ flag ภาษา (ซ่อนอยู่) -->
    <div class="flags-multilang" style="display:none;"></div>
    <h1>Ordering Food (Tap to Record)</h1>
    <div class="record-section">
      <button id="recordBtn" title="กดเพื่อเริ่ม/หยุดบันทึกเสียง">
        <span class="material-icons" id="micIcon">mic</span>
      </button>
      <div id="recordStatus" class="record-status"></div>
    </div>
    <audio id="audioPlayer" controls style="display:none; margin-top: 15px;"></audio>
    <div class="results">
      <h2>Transcribed Text:</h2>
      <pre id="transcribedText" class="transcribed-text"></pre>
      <h2>AI Response:</h2>
      <div id="aiResponseContainer" class="ai-response"></div>
    </div>
    <div id="menuImageContainer" style="margin-top: 20px;">
      <h2>Menu Detected:</h2>
      <img id="menuImage" src="" alt="เมนูอาหาร" style="max-width: 300px; display: none; border-radius: 10px;" />
    </div>
    <div class="order-section">
      <label>Table:</label>
      <input type="text" id="tableInput" placeholder="A1-10" style="width:45px;">
      <div id="orderSummary"></div>
    </div>
    <button class="send-order-btn" onclick="sendOrder()">Send Order</button>
    <button class="reset-chat-btn" onclick="resetChat()">♻️ Reset การสนทนา</button>
  </div>

<script>
const defaultURL = "https://app.solvelysaid.space";
const fallbackURL = "https://solvelysaidbn.onrender.com";
let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;

async function checkServer(url) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 3000);
  try {
    const res = await fetch(new URL("/ping", url), {
      method: "GET",
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    if (res.ok) {
      sessionStorage.setItem("workingBaseURL", url);
      baseURL = url;
      console.log("✅ Server OK at", url);
      return true;
    }
  } catch (err) {
    console.error("❌ Ping failed:", err.message);
  }
  clearTimeout(timeoutId);
  return false;
}

(async () => {
  const ok = await checkServer(baseURL);
  if (!ok) {
    const fallbackOk = await checkServer(fallbackURL);
    if (!fallbackOk) {
      alert("❌ ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ใดๆ ได้ กรุณาตรวจสอบเครือข่าย");
    }
  }
})();
</script>

<script>
// ---------- Language Flags: เตรียมไว้แต่ยังไม่โชว์ ----------
const allLangFlags = [
  { lang: "en", flag: "gb", name: "English" },
  { lang: "zh", flag: "cn", name: "Chinese" },
  { lang: "es", flag: "es", name: "Spanish" },
  { lang: "hi", flag: "in", name: "Hindi" },
  { lang: "ar", flag: "sa", name: "Arabic" },
  { lang: "fr", flag: "fr", name: "French" },
  { lang: "ru", flag: "ru", name: "Russian" },
  { lang: "pt", flag: "pt", name: "Portuguese" },
  { lang: "bn", flag: "bd", name: "Bengali" },
  { lang: "de", flag: "de", name: "German" },
  { lang: "ja", flag: "jp", name: "Japanese" },
  { lang: "pa", flag: "in", name: "Punjabi" },
  { lang: "ur", flag: "pk", name: "Urdu" },
  { lang: "ko", flag: "kr", name: "Korean" },
  { lang: "vi", flag: "vn", name: "Vietnamese" },
  { lang: "it", flag: "it", name: "Italian" },
  { lang: "jv", flag: "id", name: "Javanese" },
  { lang: "tl", flag: "ph", name: "Filipino" },
  { lang: "tr", flag: "tr", name: "Turkish" },
  { lang: "th", flag: "th", name: "Thai" },
  { lang: "ta", flag: "in", name: "Tamil" },
  { lang: "te", flag: "in", name: "Telugu" },
  { lang: "mr", flag: "in", name: "Marathi" },
  { lang: "gu", flag: "in", name: "Gujarati" },
  { lang: "fa", flag: "ir", name: "Persian" },
  { lang: "pl", flag: "pl", name: "Polish" },
  { lang: "uk", flag: "ua", name: "Ukrainian" },
  { lang: "ro", flag: "ro", name: "Romanian" },
  { lang: "nl", flag: "nl", name: "Dutch" },
  { lang: "el", flag: "gr", name: "Greek" },
  { lang: "hu", flag: "hu", name: "Hungarian" },
  { lang: "sv", flag: "se", name: "Swedish" },
  { lang: "cs", flag: "cz", name: "Czech" },
  { lang: "he", flag: "il", name: "Hebrew" },
  { lang: "id", flag: "id", name: "Indonesian" },
  { lang: "ms", flag: "my", name: "Malay" },
  { lang: "uz", flag: "uz", name: "Uzbek" },
  { lang: "kk", flag: "kz", name: "Kazakh" },
  { lang: "az", flag: "az", name: "Azerbaijani" },
  { lang: "ne", flag: "np", name: "Nepali" },
  { lang: "km", flag: "kh", name: "Khmer" },
  { lang: "am", flag: "et", name: "Amharic" },
  { lang: "lo", flag: "la", name: "Lao" },
  { lang: "my", flag: "mm", name: "Myanmar (Burmese)" },
  { lang: "si", flag: "lk", name: "Sinhala" },
  { lang: "sw", flag: "ke", name: "Swahili" },
  { lang: "bs", flag: "ba", name: "Bosnian" },
  { lang: "hr", flag: "hr", name: "Croatian" },
  { lang: "sr", flag: "rs", name: "Serbian" },
  { lang: "bg", flag: "bg", name: "Bulgarian" },
  { lang: "sk", flag: "sk", name: "Slovak" },
  { lang: "sl", flag: "si", name: "Slovenian" },
  { lang: "lt", flag: "lt", name: "Lithuanian" },
  { lang: "lv", flag: "lv", name: "Latvian" },
  { lang: "et", flag: "ee", name: "Estonian" },
  { lang: "af", flag: "za", name: "Afrikaans" },
  { lang: "da", flag: "dk", name: "Danish" },
  { lang: "fi", flag: "fi", name: "Finnish" },
  { lang: "no", flag: "no", name: "Norwegian" },
  { lang: "nn", flag: "no", name: "Nynorsk" },
  { lang: "is", flag: "is", name: "Icelandic" },
  { lang: "hy", flag: "am", name: "Armenian" },
  { lang: "ka", flag: "ge", name: "Georgian" },
  { lang: "ht", flag: "ht", name: "Haitian Creole" },
  { lang: "ha", flag: "ng", name: "Hausa" },
  { lang: "haw", flag: "us", name: "Hawaiian" },
  { lang: "ga", flag: "ie", name: "Irish" },
  { lang: "jw", flag: "id", name: "Javanese" },
  { lang: "kn", flag: "in", name: "Kannada" },
  { lang: "la", flag: "va", name: "Latin" },
  { lang: "ln", flag: "cg", name: "Lingala" },
  { lang: "lb", flag: "lu", name: "Luxembourgish" },
  { lang: "mk", flag: "mk", name: "Macedonian" },
  { lang: "mg", flag: "mg", name: "Malagasy" },
  { lang: "ml", flag: "in", name: "Malayalam" },
  { lang: "mt", flag: "mt", name: "Maltese" },
  { lang: "mi", flag: "nz", name: "Maori" },
  { lang: "mn", flag: "mn", name: "Mongolian" },
  { lang: "oc", flag: "fr", name: "Occitan" },
  { lang: "ps", flag: "af", name: "Pashto" },
  { lang: "sa", flag: "in", name: "Sanskrit" },
  { lang: "sn", flag: "zw", name: "Shona" },
  { lang: "sd", flag: "pk", name: "Sindhi" },
  { lang: "so", flag: "so", name: "Somali" },
  { lang: "tg", flag: "tj", name: "Tajik" },
  { lang: "tt", flag: "ru", name: "Tatar" },
  { lang: "bo", flag: "cn", name: "Tibetan" },
  { lang: "tk", flag: "tm", name: "Turkmen" },
  { lang: "cy", flag: "gb-wls", name: "Welsh" },
  { lang: "yi", flag: "ua", name: "Yiddish" },
  { lang: "yo", flag: "ng", name: "Yoruba" },
  { lang: "fo", flag: "fo", name: "Faroese" },
  { lang: "br", flag: "fr", name: "Breton" }
];


window.addEventListener('DOMContentLoaded', () => {
  // โชว์แค่ธงภาษาปัจจุบัน
  const selectedLangCode = localStorage.getItem('selectedLanguage') || 'th';
  const selectedLang = allLangFlags.find(l => l.code === selectedLangCode) || allLangFlags.find(l => l.code === 'th');
  document.getElementById('selectedLanguageDisplay').innerHTML =
    `<img src="${selectedLang.flag}" alt="${selectedLang.name} Flag" style="width:28px;vertical-align:middle;border-radius:5px;" /> <b>${selectedLang.name}</b>`;

  // ---- (ถ้าอยาก render flags-multilang ทีหลัง ให้ใช้ function นี้) ----
  // function renderFlags() {
  //   const flagsDiv = document.querySelector('.flags-multilang');
  //   flagsDiv.innerHTML = allLangFlags.map(l =>
  //     `<div class="flag-item" data-lang="${l.code}">
  //        <img src="${l.flag}" alt="${l.name}" />
  //        <span>${l.name}</span>
  //      </div>`
  //   ).join('');
  //   flagsDiv.style.display = "flex";
  // }
});
</script>

<script>
const recordBtn = document.getElementById("recordBtn");
const micIcon = document.getElementById("micIcon");
const recordStatus = document.getElementById("recordStatus");
const audioPlayer = document.getElementById("audioPlayer");

let mediaRecorder;
let audioChunks = [];
let audioContext, analyser, sourceNode;
let silenceTimeout, maxDurationTimeout;
let isRecording = false;

const silenceThreshold = 0.01;
const silenceLimit = 5000;
const maxRecordingDuration = 10000;

recordBtn.addEventListener("click", () => {
  if (!isRecording) {
    startRecording();
  } else {
    stopRecording();
  }
});

function monitorSilence(stream) {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  sourceNode = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 2048;
  const dataArray = new Uint8Array(analyser.fftSize);
  sourceNode.connect(analyser);

  const checkSilence = () => {
    analyser.getByteTimeDomainData(dataArray);
    const rms = Math.sqrt(dataArray.reduce((sum, val) => {
      const norm = (val - 128) / 128;
      return sum + norm * norm;
    }, 0) / dataArray.length);

    if (rms < silenceThreshold) {
      if (!silenceTimeout) {
        silenceTimeout = setTimeout(() => {
          console.log("🔕 ไม่มีเสียง → หยุดอัด");
          stopRecording();
        }, silenceLimit);
      }
    } else {
      clearTimeout(silenceTimeout);
      silenceTimeout = null;
    }

    if (isRecording) requestAnimationFrame(checkSilence);
  };

  checkSilence();
}

function startRecording() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.style.display = "block";

      const selectedLangCode = localStorage.getItem('selectedLanguage') || 'th';

      const formData = new FormData();
      formData.append("file", audioBlob, "recorded_audio.webm");
      formData.append("language", selectedLangCode);

      fetch(new URL("/upload", baseURL), {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(result => {
        document.getElementById("transcribedText").textContent = result.text || "";
        const aiResponseDiv = document.getElementById("aiResponseContainer");
        aiResponseDiv.textContent = result.chat_response || "";

        if (result.menu) {
          updateOrderSummary(result.menu);
          const menuImg = document.getElementById("menuImage");
          menuImg.src = new URL(`/image/720p/${encodeURIComponent(result.menu)}`, baseURL);
          menuImg.alt = result.menu;
          menuImg.style.display = "block";
        } else {
          document.getElementById("orderSummary").textContent = "";
          detectedMenu = null;
          document.getElementById("menuImage").style.display = "none";
        }
      })
      .catch(() => alert("❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้"));

      recordStatus.textContent = "";
      micIcon.textContent = "mic";
      recordBtn.classList.remove("recording");
      isRecording = false;

      audioContext?.close();
    };

    mediaRecorder.start();
    isRecording = true;

    monitorSilence(stream);

    maxDurationTimeout = setTimeout(() => {
      console.log("⏱️ ครบ 10 วิ → หยุดอัด");
      stopRecording();
    }, maxRecordingDuration);

    recordStatus.textContent = "🔴 กำลังบันทึกเสียง...";
    micIcon.textContent = "stop";
    recordBtn.classList.add("recording");
  }).catch(err => {
    alert("ไม่สามารถเข้าถึงไมโครโฟน: " + err.message);
  });
}

function stopRecording() {
  if (!mediaRecorder || mediaRecorder.state !== "recording") return;
  mediaRecorder.stop();
  clearTimeout(silenceTimeout);
  clearTimeout(maxDurationTimeout);
}

// ==== ORDER JS ====
let detectedMenu = null;

function updateOrderSummary(menuName) {
  if (menuName) {
    detectedMenu = { name: menuName, qty: 1 };
    document.getElementById('orderSummary').textContent =
      `รายการ: ${menuName} × ${detectedMenu.qty}`;
  }
}

function sendOrder() {
  const tableNumber = document.getElementById('tableInput').value.trim();
  const aiSummary = document.getElementById('aiResponseContainer').textContent.trim();
  if (!tableNumber) {
    alert("กรุณาระบุหมายเลขโต๊ะ");
    return;
  }
  if (!aiSummary) {
    alert("ยังไม่มีสรุปออเดอร์จาก AI");
    return;
  }
  fetch(new URL("/order", baseURL), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      table_number: tableNumber,
      menus: detectedMenu ? [detectedMenu] : [],
      summary: aiSummary
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      alert("ส่งออเดอร์เรียบร้อย");
      document.getElementById('orderSummary').textContent = '';
      detectedMenu = null;
    } else {
      alert(result.error || "ส่งออเดอร์ไม่สำเร็จ");
    }
  });
}

function resetChat() {
  fetch(new URL("/chat", baseURL), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: "reset" })
  })
  .then(res => res.json())
  .then(result => {
    alert(result.response || "รีเซ็ตแล้ว");
    document.getElementById("transcribedText").textContent = "reset";
    document.getElementById("aiResponseContainer").textContent = result.response || "";
    document.getElementById("menuImage").style.display = "none";
    document.getElementById("orderSummary").textContent = '';
    detectedMenu = null;
  })
  .catch(() => {
    alert("❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้");
  });
}
</script>
</body>
</html>
