<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบบันทึกเสียง พร้อม AI Response</title>
  <link rel="icon" type="image/png" href="solvely.png" />
  <link rel="stylesheet" href="main.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script>
    const isAuthenticated = sessionStorage.getItem("authenticated") === "true";
    const isLocal = [
      'localhost',
      '127.0.0.1',
      '::1'
    ].includes(window.location.hostname) || 
    window.location.protocol === 'file:';

    if (!isAuthenticated && !isLocal) {
      window.location.href = "/";
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="selected-language" id="selectedLanguageDisplay"></div>
    <h1>Ordering Food (Tap to Record)</h1>
    <div class="record-section">
      <button id="recordBtn" title="กดเพื่อเริ่ม/หยุดบันทึกเสียง">
        <span class="material-icons" id="micIcon">mic</span>
      </button>
      <div id="recordStatus" class="record-status"></div>
    </div>
    <audio id="audioPlayer" controls style="display:none; margin-top: 15px;"></audio>
    <div class="results">
      <h2>Transcribed Text:</h2>
      <pre id="transcribedText" class="transcribed-text"></pre>
      <h2>AI Response:</h2>
      <div id="aiResponseContainer" class="ai-response"></div>
    </div>
    <div id="menuImageContainer" style="margin-top: 20px;">
      <h2>Menu Detected:</h2>
      <img id="menuImage" src="" alt="เมนูอาหาร" style="max-width: 300px; display: none; border-radius: 10px;" />
    </div>
    <button class="send-order-btn">Send Order</button>
    <button class="reset-chat-btn" onclick="resetChat()">♻️ Reset การสนทนา</button>
  </div>

<script>
const defaultURL = "https://app.solvelysaid.space";
const fallbackURL = "https://solvelysaidbn.onrender.com";
let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;

async function checkServer(url) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 3000);
  try {
    const res = await fetch(new URL("/ping", url), {
      method: "GET",
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    if (res.ok) {
      sessionStorage.setItem("workingBaseURL", url);
      baseURL = url;
      console.log("✅ Server OK at", url);
      return true;
    }
  } catch (err) {
    console.error("❌ Ping failed:", err.message);
  }
  clearTimeout(timeoutId);
  return false;
}

(async () => {
  const ok = await checkServer(baseURL);
  if (!ok) {
    const fallbackOk = await checkServer(fallbackURL);
    if (!fallbackOk) {
      alert("❌ ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ใดๆ ได้ กรุณาตรวจสอบเครือข่าย");
    }
  }
})();
</script>

<script>
const langMap = {
      af:{name:"Afrikaans",flag:"https://flagcdn.com/w40/za.png"},
      sq:{name:"Albanian",flag:"https://flagcdn.com/w40/al.png"},
      am:{name:"Amharic",flag:"https://flagcdn.com/w40/et.png"},
      ar:{name:"Arabic",flag:"https://flagcdn.com/w40/sa.png"},
      hy:{name:"Armenian",flag:"https://flagcdn.com/w40/am.png"},
      az:{name:"Azerbaijani",flag:"https://flagcdn.com/w40/az.png"},
      eu:{name:"Basque",flag:"https://flagcdn.com/w40/es.png"},
      be:{name:"Belarusian",flag:"https://flagcdn.com/w40/by.png"},
      bn:{name:"Bengali",flag:"https://flagcdn.com/w40/bd.png"},
      bs:{name:"Bosnian",flag:"https://flagcdn.com/w40/ba.png"},
      br:{name:"Breton",flag:"https://flagcdn.com/w40/fr.png"},
      bg:{name:"Bulgarian",flag:"https://flagcdn.com/w40/bg.png"},
      my:{name:"Burmese",flag:"https://flagcdn.com/w40/mm.png"},
      ca:{name:"Catalan",flag:"https://flagcdn.com/w40/es.png"},
      zh:{name:"Chinese",flag:"https://flagcdn.com/w40/cn.png"},
      hr:{name:"Croatian",flag:"https://flagcdn.com/w40/hr.png"},
      cs:{name:"Czech",flag:"https://flagcdn.com/w40/cz.png"},
      da:{name:"Danish",flag:"https://flagcdn.com/w40/dk.png"},
      nl:{name:"Dutch",flag:"https://flagcdn.com/w40/nl.png"},
      en:{name:"English",flag:"https://flagcdn.com/w40/gb.png"},
      et:{name:"Estonian",flag:"https://flagcdn.com/w40/ee.png"},
      fo:{name:"Faroese",flag:"https://flagcdn.com/w40/fo.png"},
      fi:{name:"Finnish",flag:"https://flagcdn.com/w40/fi.png"},
      fr:{name:"French",flag:"https://flagcdn.com/w40/fr.png"},
      gl:{name:"Galician",flag:"https://flagcdn.com/w40/es.png"},
      ka:{name:"Georgian",flag:"https://flagcdn.com/w40/ge.png"},
      de:{name:"German",flag:"https://flagcdn.com/w40/de.png"},
      el:{name:"Greek",flag:"https://flagcdn.com/w40/gr.png"},
      gu:{name:"Gujarati",flag:"https://flagcdn.com/w40/in.png"},
      ht:{name:"Haitian Creole",flag:"https://flagcdn.com/w40/ht.png"},
      ha:{name:"Hausa",flag:"https://flagcdn.com/w40/ng.png"},
      haw:{name:"Hawaiian",flag:"https://flagcdn.com/w40/us.png"},
      he:{name:"Hebrew",flag:"https://flagcdn.com/w40/il.png"},
      hi:{name:"Hindi",flag:"https://flagcdn.com/w40/in.png"},
      hu:{name:"Hungarian",flag:"https://flagcdn.com/w40/hu.png"},
      is:{name:"Icelandic",flag:"https://flagcdn.com/w40/is.png"},
      id:{name:"Indonesian",flag:"https://flagcdn.com/w40/id.png"},
      ga:{name:"Irish",flag:"https://flagcdn.com/w40/ie.png"},
      it:{name:"Italian",flag:"https://flagcdn.com/w40/it.png"},
      ja:{name:"Japanese",flag:"https://flagcdn.com/w40/jp.png"},
      jw:{name:"Javanese",flag:"https://flagcdn.com/w40/id.png"},
      kn:{name:"Kannada",flag:"https://flagcdn.com/w40/in.png"},
      kk:{name:"Kazakh",flag:"https://flagcdn.com/w40/kz.png"},
      km:{name:"Khmer",flag:"https://flagcdn.com/w40/kh.png"},
      ko:{name:"Korean",flag:"https://flagcdn.com/w40/kr.png"},
      la:{name:"Latin",flag:"https://flagcdn.com/w40/va.png"},
      lv:{name:"Latvian",flag:"https://flagcdn.com/w40/lv.png"},
      ln:{name:"Lingala",flag:"https://flagcdn.com/w40/cg.png"},
      lt:{name:"Lithuanian",flag:"https://flagcdn.com/w40/lt.png"},
      lb:{name:"Luxembourgish",flag:"https://flagcdn.com/w40/lu.png"},
      mk:{name:"Macedonian",flag:"https://flagcdn.com/w40/mk.png"},
      mg:{name:"Malagasy",flag:"https://flagcdn.com/w40/mg.png"},
      ms:{name:"Malay",flag:"https://flagcdn.com/w40/my.png"},
      ml:{name:"Malayalam",flag:"https://flagcdn.com/w40/in.png"},
      mt:{name:"Maltese",flag:"https://flagcdn.com/w40/mt.png"},
      mi:{name:"Maori",flag:"https://flagcdn.com/w40/nz.png"},
      mr:{name:"Marathi",flag:"https://flagcdn.com/w40/in.png"},
      mn:{name:"Mongolian",flag:"https://flagcdn.com/w40/mn.png"},
      ne:{name:"Nepali",flag:"https://flagcdn.com/w40/np.png"},
      no:{name:"Norwegian",flag:"https://flagcdn.com/w40/no.png"},
      nn:{name:"Nynorsk",flag:"https://flagcdn.com/w40/no.png"},
      oc:{name:"Occitan",flag:"https://flagcdn.com/w40/fr.png"},
      pa:{name:"Punjabi",flag:"https://flagcdn.com/w40/in.png"},
      ps:{name:"Pashto",flag:"https://flagcdn.com/w40/af.png"},
      fa:{name:"Persian",flag:"https://flagcdn.com/w40/ir.png"},
      pl:{name:"Polish",flag:"https://flagcdn.com/w40/pl.png"},
      pt:{name:"Portuguese",flag:"https://flagcdn.com/w40/pt.png"},
      ro:{name:"Romanian",flag:"https://flagcdn.com/w40/ro.png"},
      ru:{name:"Russian",flag:"https://flagcdn.com/w40/ru.png"},
      sa:{name:"Sanskrit",flag:"https://flagcdn.com/w40/in.png"},
      sr:{name:"Serbian",flag:"https://flagcdn.com/w40/rs.png"},
      sn:{name:"Shona",flag:"https://flagcdn.com/w40/zw.png"},
      sd:{name:"Sindhi",flag:"https://flagcdn.com/w40/pk.png"},
      si:{name:"Sinhala",flag:"https://flagcdn.com/w40/lk.png"},
      sk:{name:"Slovak",flag:"https://flagcdn.com/w40/sk.png"},
      sl:{name:"Slovenian",flag:"https://flagcdn.com/w40/si.png"},
      so:{name:"Somali",flag:"https://flagcdn.com/w40/so.png"},
      es:{name:"Spanish",flag:"https://flagcdn.com/w40/es.png"},
      sw:{name:"Swahili",flag:"https://flagcdn.com/w40/ke.png"},
      sv:{name:"Swedish",flag:"https://flagcdn.com/w40/se.png"},
      tl:{name:"Tagalog",flag:"https://flagcdn.com/w40/ph.png"},
      tg:{name:"Tajik",flag:"https://flagcdn.com/w40/tj.png"},
      ta:{name:"Tamil",flag:"https://flagcdn.com/w40/in.png"},
      tt:{name:"Tatar",flag:"https://flagcdn.com/w40/ru.png"},
      te:{name:"Telugu",flag:"https://flagcdn.com/w40/in.png"},
      th:{name:"Thai",flag:"https://flagcdn.com/w40/th.png"},
      bo:{name:"Tibetan",flag:"https://flagcdn.com/w40/cn.png"},
      jv:{name:"Javanese",flag:"https://flagcdn.com/w40/id.png" },
      lo:{name:"Lao",flag:"https://flagcdn.com/w40/la.png" },
      ur:{name:"Urdu",flag:"https://flagcdn.com/w40/pk.png" },
      vi:{name:"Vietnamese",flag:"https://flagcdn.com/w40/vn.png" },
      uk:{name:"Ukrainian",flag:"https://flagcdn.com/w40/ua.png" },
      uz:{name:"Uzbek",flag:"https://flagcdn.com/w40/uz.png" },
      tr:{name:"Turkish",flag:"https://flagcdn.com/w40/tr.png"},
      tk:{name:"Turkmen",flag:"https://flagcdn.com/w40/tm.png"},
      cy:{name:"Welsh",flag:"https://flagcdn.com/w40/gb-wls.png"},
      yi:{name:"Yiddish",flag:"https://flagcdn.com/w40/ua.png"},
      yo:{name:"Yoruba",flag:"https://flagcdn.com/w40/ng.png"},
      fo:{name:"Faroese",flag:"https://flagcdn.com/w40/fo.png"}
    };
  
const selectedLangCode = localStorage.getItem('selectedLanguage') || 'th';
const selectedLang = langMap[selectedLangCode] || langMap['th'];
document.getElementById('selectedLanguageDisplay').innerHTML = `<img src="${selectedLang.flag}" alt="${selectedLang.name} Flag" /> ${selectedLang.name}`;

const recordBtn = document.getElementById("recordBtn");
const micIcon = document.getElementById("micIcon");
const recordStatus = document.getElementById("recordStatus");
const audioPlayer = document.getElementById("audioPlayer");

let mediaRecorder;
let audioChunks = [];
let audioContext, analyser, sourceNode;
let silenceTimeout, maxDurationTimeout;
let isRecording = false;

const silenceThreshold = 0.01;
const silenceLimit = 5000;
const maxRecordingDuration = 10000;

recordBtn.addEventListener("click", () => {
  if (!isRecording) {
    startRecording();
  } else {
    stopRecording();
  }
});

function monitorSilence(stream) {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  sourceNode = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 2048;
  const dataArray = new Uint8Array(analyser.fftSize);
  sourceNode.connect(analyser);

  const checkSilence = () => {
    analyser.getByteTimeDomainData(dataArray);
    const rms = Math.sqrt(dataArray.reduce((sum, val) => {
      const norm = (val - 128) / 128;
      return sum + norm * norm;
    }, 0) / dataArray.length);

    if (rms < silenceThreshold) {
      if (!silenceTimeout) {
        silenceTimeout = setTimeout(() => {
          console.log("🔕 ไม่มีเสียง → หยุดอัด");
          stopRecording();
        }, silenceLimit);
      }
    } else {
      clearTimeout(silenceTimeout);
      silenceTimeout = null;
    }

    if (isRecording) requestAnimationFrame(checkSilence);
  };

  checkSilence();
}

function startRecording() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.style.display = "block";

      const formData = new FormData();
      formData.append("file", audioBlob, "recorded_audio.webm");
      formData.append("language", selectedLangCode);

      fetch(new URL("/upload", baseURL), {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(result => {
        document.getElementById("transcribedText").textContent = result.text || "";
        const aiResponseDiv = document.getElementById("aiResponseContainer");
        aiResponseDiv.textContent = result.chat_response || "";

        if (result.menu) {
          const menuImg = document.getElementById("menuImage");
          menuImg.src = new URL(`/image/720p/${encodeURIComponent(result.menu)}`, baseURL);
          menuImg.alt = result.menu;
          menuImg.style.display = "block";
        } else {
          document.getElementById("menuImage").style.display = "none";
        }
      })
      .catch(() => alert("❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้"));

      recordStatus.textContent = "";
      micIcon.textContent = "mic";
      recordBtn.classList.remove("recording");
      isRecording = false;

      audioContext?.close();
    };

    mediaRecorder.start();
    isRecording = true;

    monitorSilence(stream);

    maxDurationTimeout = setTimeout(() => {
      console.log("⏱️ ครบ 10 วิ → หยุดอัด");
      stopRecording();
    }, maxRecordingDuration);

    recordStatus.textContent = "🔴 กำลังบันทึกเสียง...";
    micIcon.textContent = "stop";
    recordBtn.classList.add("recording");
  }).catch(err => {
    alert("ไม่สามารถเข้าถึงไมโครโฟน: " + err.message);
  });
}

function stopRecording() {
  if (!mediaRecorder || mediaRecorder.state !== "recording") return;
  mediaRecorder.stop();
  clearTimeout(silenceTimeout);
  clearTimeout(maxDurationTimeout);
}
</script>

<script>
function resetChat() {
  fetch(new URL("/chat", baseURL), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: "reset" })
  })
  .then(res => res.json())
  .then(result => {
    alert(result.response || "รีเซ็ตแล้ว");
    document.getElementById("transcribedText").textContent = "reset";
    document.getElementById("aiResponseContainer").textContent = result.response || "";
    document.getElementById("menuImage").style.display = "none";
  })
  .catch(() => {
    alert("❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้");
  });
}
</script>
</body>
</html>
