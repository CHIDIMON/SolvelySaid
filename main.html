<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏° AI Response</title>
  <link rel="icon" type="image/png" href="solvely.png" />
  <link rel="stylesheet" href="main.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
</head>
<body>

  <div class="container">

    <div class="selected-language" id="selectedLanguageDisplay"></div>

    <h1>Ordering Food Holding The Button</h1>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á container -->
    <div class="record-section">
      <button id="recordBtn" title="‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á">
        <span class="material-icons" id="micIcon">mic</span>
      </button>
      <div id="recordStatus" class="record-status"></div>
    </div>

    <audio id="audioPlayer" controls style="display:none; margin-top: 15px;"></audio>

    <div class="results">
      <h2>Transcribed Text:</h2>
      <pre id="transcribedText" class="transcribed-text"></pre>

      <h2>AI Response:</h2>
      <div id="aiResponseContainer" class="ai-response"></div>
    </div>

    <div id="menuImageContainer" style="margin-top: 20px;">
      <h2>Menu Detech:</h2>
      <img id="menuImage" src="" alt="‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£" style="max-width: 300px; display: none; border-radius: 10px;" />
    </div>

    <button class="send-order-btn">Send Order</button>
    <button class="reset-chat-btn" onclick="resetChat()" >
      ‚ôªÔ∏è Reset ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
    </button>

  </div>

  <script>
  const defaultURL = "https://app.solvelysaid.space/"; // Cloudflared
  const fallbackURL = "https://solvelysaidbn.onrender.com"; // Render

  // ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ fallback ‡πÄ‡∏õ‡πá‡∏ô defaultURL
  let baseURL = localStorage.getItem("workingBaseURL") || defaultURL;

  async function checkServer(url) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 2000); // timeout 2 ‡∏ß‡∏¥

    try {
      const res = await fetch(url + "ping", { method: "GET", signal: controller.signal });
      clearTimeout(timeoutId);
      if (res.ok) {
        localStorage.setItem("workingBaseURL", url);
        baseURL = url;
        return true;
      }
    } catch {
      clearTimeout(timeoutId);
      return false;
    }
  }

  (async () => {
    const ok = await checkServer(baseURL);
    if (!ok) {
      const fallbackOk = await checkServer(fallbackURL);
      if (!fallbackOk) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÉ‡∏î‡πÜ ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢");
      }
    }
    console.log("üì° baseURL in use:", baseURL);
  })();
</script>


 <script>


  const langMap = {
    th: { name: "Thai", flag: "https://flagcdn.com/w40/th.png" },
    en: { name: "English", flag: "https://flagcdn.com/w40/gb.png" },
    zh: { name: "Chinese (Mandarin)", flag: "https://flagcdn.com/w40/cn.png" },
    ja: { name: "Japanese", flag: "https://flagcdn.com/w40/jp.png" },
    ko: { name: "Korean", flag: "https://flagcdn.com/w40/kr.png" },
    fr: { name: "French", flag: "https://flagcdn.com/w40/fr.png" },
    de: { name: "German", flag: "https://flagcdn.com/w40/de.png" },
    es: { name: "Spanish", flag: "https://flagcdn.com/w40/es.png" },
    ru: { name: "Russian", flag: "https://flagcdn.com/w40/ru.png" },
    ar: { name: "Arabic", flag: "https://flagcdn.com/w40/sa.png" },
    vi: { name: "Vietnamese", flag: "https://flagcdn.com/w40/vn.png" },
    hi: { name: "Hindi", flag: "https://flagcdn.com/w40/in.png" },
    id: { name: "Indonesian", flag: "https://flagcdn.com/w40/id.png" },
    tr: { name: "Turkish", flag: "https://flagcdn.com/w40/tr.png" },
    pt: { name: "Portuguese", flag: "https://flagcdn.com/w40/pt.png" }
  };

  const selectedLangCode = localStorage.getItem('selectedLanguage') || 'th';
  const selectedLang = langMap[selectedLangCode] || langMap['th'];
  const langDisplayDiv = document.getElementById('selectedLanguageDisplay');
  langDisplayDiv.innerHTML = `<img src="${selectedLang.flag}" alt="${selectedLang.name} Flag" /> ${selectedLang.name}`;

  const recordBtn = document.getElementById("recordBtn");
  const micIcon = document.getElementById("micIcon");
  const recordStatus = document.getElementById("recordStatus");
  const audioPlayer = document.getElementById("audioPlayer");
  let mediaRecorder;
  let audioChunks = [];

  recordBtn.addEventListener("mousedown", startRecording);
  recordBtn.addEventListener("mouseup", stopRecording);
  recordBtn.addEventListener("mouseleave", () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      stopRecording();
    }
  });

  function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstart = () => {
          recordStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
          recordBtn.classList.add("recording");
        };

        mediaRecorder.onstop = async () => {
          recordStatus.textContent = "";
          recordBtn.classList.remove("recording");
          micIcon.textContent = "mic";

          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          audioPlayer.src = audioUrl;
          audioPlayer.style.display = "block";

          const formData = new FormData();
          formData.append("file", audioBlob, "recorded_audio.webm");
          formData.append("language", selectedLangCode);

          try {
            const response = await fetch(`${baseURL}/upload`, {
              method: "POST",
              body: formData
            });
            const result = await response.json();

            if (response.ok) {
              document.getElementById("transcribedText").textContent = result.text || "";
              const aiResponseDiv = document.getElementById("aiResponseContainer");
              aiResponseDiv.textContent = result.chat_response || "";
              aiResponseDiv.querySelectorAll("img").forEach(img => img.remove());

              if (result.menu) {
                const menuImg = document.getElementById("menuImage");
                menuImg.src = `${baseURL}/image/${encodeURIComponent(result.menu)}`;
                menuImg.alt = result.menu;
                menuImg.style.display = "block";
              } else {
                document.getElementById("menuImage").style.display = "none";
              }

            } else {
              alert(result.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            }
          } catch {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
          }
        };

        mediaRecorder.start();
      })
      .catch(err => {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô: " + err.message);
      });
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
  }

  function resetChat() {
    fetch(`${baseURL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: "reset" })
    })
    .then(res => res.json())
    .then(result => {
      alert(result.response || "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
      document.getElementById("transcribedText").textContent = "reset";
      document.getElementById("aiResponseContainer").textContent = result.response || "";
      document.getElementById("menuImage").style.display = "none";
    })
    .catch(() => {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
    });
  }
</script>
