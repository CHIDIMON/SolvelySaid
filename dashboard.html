<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div class="dashboard-container">
    <h1>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
    <div class="order-list" id="orderList"></div>
  </div>
<script>
const defaultURL = "https://app.solvelysaid.space";
const fallbackURL = "https://solvelysaidbn.onrender.com";
let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;

// Helper function: fetch ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏•‡∏±‡∏ö fallback ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤ network error ‡∏´‡∏£‡∏∑‡∏≠ status error
function fetchWithFallback(url, opt) {
  return fetch(url, opt)
    .then(r => {
      if (r.ok) {
        sessionStorage.setItem("workingBaseURL", baseURL);
        return r;
      }
      // ‡∏ñ‡πâ‡∏≤ status error ‡πÄ‡∏ä‡πà‡∏ô 404/500/530 ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á fallbackURL
      if (baseURL !== fallbackURL) {
        baseURL = fallbackURL;
        return fetch(fallbackURL + url.slice(defaultURL.length), opt)
          .then(r2 => {
            if (r2.ok) sessionStorage.setItem("workingBaseURL", baseURL);
            return r2;
          });
      }
      return r;
    })
    .catch(err => {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô network error (server ‡∏•‡πà‡∏°, ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô fallbackURL ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (baseURL !== fallbackURL) {
        baseURL = fallbackURL;
        sessionStorage.setItem("workingBaseURL", baseURL);
        return fetch(fallbackURL + url.slice(defaultURL.length), opt);
      }
      throw err;
    });
}

function statusText(st) {
  if(st === "waiting") return "üü° ‡∏£‡∏≠‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£";
  if(st === "cooking") return "üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß";
  if(st === "served") return "‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß";
  return st || "-";
}
function statusClass(st) {
  if(st === "waiting") return "status waiting";
  if(st === "cooking") return "status cooking";
  if(st === "served") return "status served";
  return "status";
}

function renderOrders(orders) {
  const list = document.getElementById('orderList');
  list.innerHTML = "";
  if(!orders || !orders.length) {
    list.innerHTML = "<div style='color:#888;text-align:center;padding:30px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>";
    return;
  }
  orders.forEach(order => {
    let time = order.timestamp ? new Date(order.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : "-";
    let items = (order.menus || []).map((m,i) => `<li>${i+1}. ${m.name}${m.qty?` x${m.qty}`:""}</li>`).join('');
    let showFinish = order.status !== "served";
    let showDelete = order.status === "served";
    list.innerHTML += `
      <div class="order-card" data-id="${order.id}">
        ${showFinish ? `<button class="finish-btn finish" onclick="finishOrder('${order.id}', this)">Click To Finish</button>` : ""}
        ${showDelete ? `<button class="finish-btn delete" onclick="deleteOrder('${order.id}', this)">Click To Delete</button>` : ""}
        <div class="order-header">
          <span class="table-id">‡πÇ‡∏ï‡πä‡∏∞ ${order.table_number || "-"}</span>
          <span class="order-time">‚è∞ ${time}</span>
        </div>
        ${order.summary ? `<div class="order-summary" style="margin-bottom:6px;color:#2359a2;">${order.summary}</div>` : ""}
        <ul class="order-items">${items}</ul>
        <div class="${statusClass(order.status)}">${statusText(order.status)}</div>
      </div>`;
  });
}

function fetchOrders() {
  fetchWithFallback(`${baseURL}/orders`)
    .then(r => r.json())
    .then(data => renderOrders(data.orders))
    .catch(() => {
      document.getElementById('orderList').innerHTML = "<div style='color:#888;text-align:center;padding:30px;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>";
    });
}

function finishOrder(orderId, btn) {
  btn.disabled = true;
  btn.textContent = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
  fetchWithFallback(`${baseURL}/order/status`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ order_id: orderId, status: "served" })
  }).then(() => {
    setTimeout(fetchOrders, 400);
  });
}

function deleteOrder(orderId, btn) {
  btn.disabled = true;
  btn.textContent = "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
  fetchWithFallback(`${baseURL}/order/delete`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ order_id: orderId })
  }).then(() => {
    setTimeout(fetchOrders, 400);
  });
}

window.finishOrder = finishOrder;
window.deleteOrder = deleteOrder;
fetchOrders();
setInterval(fetchOrders, 12000);
</script>
</body>
</html>
