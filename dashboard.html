<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link rel="stylesheet" href="dashboard.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f2f2f7;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      color: #333;
      display: flex;
      justify-content: center;
    }
    .dashboard-container {
      width: 100%;
      max-width: 600px;
      padding: 24px;
      margin: 20px;
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      text-align: center;
      color: #2c3e50;
    }
    .order-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .order-card {
      background-color: #fafafa;
      border: 1px solid #ddd;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 15px;
      color: #555;
    }
    .order-items {
      list-style: none;
      padding-left: 0;
      margin: 0 0 12px;
    }
    .order-items li {
      padding: 4px 0;
      border-bottom: 1px dashed #e0e0e0;
      font-size: 16px;
    }
    .finish-btn {
      padding: 9px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      margin-bottom: 8px;
      margin-right: 8px;
      transition: background 0.22s, color 0.22s, box-shadow 0.2s;
      box-shadow: 0 2px 6px rgba(34,139,34,0.05);
    }
    .finish-btn.finish {
      background-color: #27ae60;
      color: #fff;
    }
    .finish-btn.finish:hover:not(:disabled) {
      background-color: #239b56;
      box-shadow: 0 4px 12px rgba(39,174,96,0.16);
    }
    .finish-btn.delete {
      background-color: #e74c3c;
      color: #fff;
    }
    .finish-btn.delete:hover:not(:disabled) {
      background-color: #c0392b;
      box-shadow: 0 4px 12px rgba(231,76,60,0.16);
    }
    .finish-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    /* Status text color */
    .status.waiting { color: orange; font-weight: bold; }
    .status.cooking { color: dodgerblue; font-weight: bold;}
    .status.served { color: green; font-weight: bold;}
    .order-summary {
      margin-bottom: 6px;
      color: #2359a2;
      font-size: 15px;
      line-height: 1.7;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
    <div class="order-list" id="orderList"></div>
  </div>
<script>
const defaultURL = "https://app.solvelysaid.space";
const fallbackURL = "https://solvelysaidbn.onrender.com";
let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;

function fetchWithFallback(url, opt) {
  return fetch(url, opt)
    .then(r => {
      if (r.ok) {
        sessionStorage.setItem("workingBaseURL", baseURL);
        return r;
      }
      if (baseURL !== fallbackURL) {
        baseURL = fallbackURL;
        return fetch(fallbackURL + url.slice(defaultURL.length), opt)
          .then(r2 => {
            if (r2.ok) sessionStorage.setItem("workingBaseURL", baseURL);
            return r2;
          });
      }
      return r;
    })
    .catch(err => {
      if (baseURL !== fallbackURL) {
        baseURL = fallbackURL;
        sessionStorage.setItem("workingBaseURL", baseURL);
        return fetch(fallbackURL + url.slice(defaultURL.length), opt);
      }
      throw err;
    });
}

function statusText(st) {
  if(st === "waiting") return "üü° ‡∏£‡∏≠‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£";
  if(st === "cooking") return "üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß";
  if(st === "served") return "‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß";
  return st || "-";
}
function statusClass(st) {
  if(st === "waiting") return "status waiting";
  if(st === "cooking") return "status cooking";
  if(st === "served") return "status served";
  return "status";
}
function mergeMenus(menus) {
  const merged = {};
  (menus || []).forEach(m => {
    const key = m.name + (m.options ? JSON.stringify(m.options) : '');
    if (!merged[key]) {
      merged[key] = { ...m, qty: m.qty || 1 };
    } else {
      merged[key].qty += m.qty || 1;
    }
  });
  return Object.values(merged);
}
function formatSummary(summary) {
  if (!summary) return "";
  return summary
    .replace(/\s*\*\s*/g, "<br>")           // * => <br>
    .replace(/(\d+\.\s*)/g, "<br>$1")       // 1. 2. ... => <br>
    .replace(/^<br>/, "");                  // ‡∏•‡∏ö <br> ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î
}

function renderOrders(orders) {
  const list = document.getElementById('orderList');
  list.innerHTML = "";
  if(!orders || !orders.length) {
    list.innerHTML = "<div style='color:#888;text-align:center;padding:30px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>";
    return;
  }
  orders.forEach(order => {
    let time = order.timestamp ? new Date(order.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : "-";
    let mergedMenus = mergeMenus(order.menus || []);
    let items = mergedMenus.map((m, i) => `<li>${i+1}. ${m.name}${m.qty > 1 ? ` x${m.qty}` : ""}</li>`).join('');
    let showFinish = order.status !== "served";
    let showDelete = order.status === "served";
    list.innerHTML += `
      <div class="order-card" data-id="${order.id}">
        ${showFinish ? `<button class="finish-btn finish" onclick="finishOrder('${order.id}', this)">Click To Finish</button>` : ""}
        ${showDelete ? `<button class="finish-btn delete" onclick="deleteOrder('${order.id}', this)">Click To Delete</button>` : ""}
        <div class="order-header">
          <span class="table-id">‡πÇ‡∏ï‡πä‡∏∞ ${order.table_number || "-"}</span>
          <span class="order-time">‚è∞ ${time}</span>
        </div>
        ${
          order.summary
            ? `<div class="order-summary">${formatSummary(order.summary)}</div>`
            : `<ul class="order-items">${items}</ul>`
        }
        <div class="${statusClass(order.status)}">${statusText(order.status)}</div>
      </div>`;
  });
}

function fetchOrders() {
  fetchWithFallback(`${baseURL}/orders`)
    .then(r => r.json())
    .then(data => renderOrders(data.orders))
    .catch(() => {
      document.getElementById('orderList').innerHTML = "<div style='color:#888;text-align:center;padding:30px;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>";
    });
}
function finishOrder(orderId, btn) {
  btn.disabled = true;
  btn.textContent = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
  fetchWithFallback(`${baseURL}/order/status`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ order_id: orderId, status: "served" })
  }).then(() => {
    setTimeout(fetchOrders, 400);
  });
}
function deleteOrder(orderId, btn) {
  btn.disabled = true;
  btn.textContent = "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
  fetchWithFallback(`${baseURL}/order/delete`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ order_id: orderId })
  }).then(() => {
    setTimeout(fetchOrders, 400);
  });
}
window.finishOrder = finishOrder;
window.deleteOrder = deleteOrder;
fetchOrders();
setInterval(fetchOrders, 12000);
</script>
</body>
</html>
