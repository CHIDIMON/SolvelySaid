<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>เมนูอาหาร (Admin)</title>
  <link rel="stylesheet" href="db.css">
</head>
<body>
  <div class="container">
    <h2>จัดการเมนูอาหาร</h2>
    <form id="addMenuForm">
      <input type="text" id="name" placeholder="ชื่อเมนู" required>
      <input type="number" id="price" placeholder="ราคา" required>
      <textarea id="description" placeholder="รายละเอียดเมนู"></textarea>
      <input type="file" id="image" accept="image/*" capture="environment">
      <button type="submit">เพิ่มเมนู</button>
    </form>
    <hr>
    <h3>
      รายการเมนูทั้งหมด
      <button type="button" onclick="refreshMenus()" class="refresh-btn">รีเฟรช</button>
    </h3>
    <div id="menuList"></div>
  </div>

  <script>
    // DEBUG: จับ error ทุกอย่างบนหน้าเว็บ
    window.onerror = function(message, source, lineno, colno, error) {
      alert("JS Error: " + message + " @ " + source + " (" + lineno + ":" + colno + ")");
      console.log("JS Error:", message, "at", source, "line", lineno, "col", colno, "error:", error);
    };

    const defaultURL = "https://app.solvelysaid.space";
    const fallbackURL = "https://solvelysaidbn.onrender.com";
    let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;
    let editedMenus = {};

    function cacheMenus(menus) {
      localStorage.setItem('menu_cache', JSON.stringify(menus));
    }
    function getCachedMenus() {
      const cache = localStorage.getItem('menu_cache');
      if (cache) {
        try { return JSON.parse(cache); } catch (e) {}
      }
      return null;
    }
    function clearMenuCache() {
      localStorage.removeItem('menu_cache');
    }

    function loadMenus(requestFresh = false) {
      if (!requestFresh) {
        const cached = getCachedMenus();
        if (cached && Array.isArray(cached)) {
          renderMenus(cached);
          return;
        }
      }
      fetch(baseURL + "/debug/menus")
        .then(res => {
          if (!res.ok) throw new Error("Fetch failed");
          return res.json();
        })
        .then(data => {
          if (data.menus) {
            cacheMenus(data.menus);
            renderMenus(data.menus);
          } else {
            document.getElementById('menuList').innerHTML = "ไม่พบเมนู";
          }
          editedMenus = {};
        })
        .catch(err => {
          alert("loadMenus error: " + err.message);
          if (baseURL !== fallbackURL) {
            baseURL = fallbackURL;
            sessionStorage.setItem("workingBaseURL", baseURL);
            alert("เปลี่ยน baseURL เป็น fallback");
            loadMenus(true);
          } else {
            alert("ติดต่อ server ไม่ได้ กรุณาตรวจสอบ backend!");
          }
        });
    }

    function refreshMenus() {
      clearMenuCache();
      location.reload();
    }

    function saveAllEdits() {
      const editedArray = Object.values(editedMenus);
      if (!editedArray.length) {
        alert('ไม่มีข้อมูลที่แก้ไข');
        return;
      }
      fetch(baseURL + "/menu/edit/batch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ menus: editedArray })
      })
      .then(res => res.json())
      .then(data => {
        editedMenus = {};
        clearMenuCache();
        loadMenus(true);
      })
      .catch(() => alert("เกิดข้อผิดพลาดในการบันทึก"));
    }

    function handleEditMenu(id) {
      const name = document.getElementById('name_' + id).value;
      const price = document.getElementById('price_' + id).value;
      const description = document.getElementById('desc_' + id).value;
      editedMenus[id] = { id, name, price, description };
    }

    function renderMenus(menus) {
      let html = '<table><tr><th>รูป</th><th>ชื่อ</th><th>ราคา</th><th>รายละเอียด</th><th>จัดการ</th></tr>';
      menus.forEach(menu => {
        let imgUrl = baseURL + "/image/thumb/" + encodeURIComponent(menu.name);
        html += `<tr>
          <td data-label="รูป">
            <img src="${imgUrl}" alt="img" style="width:55px; height:55px; object-fit:cover; border-radius:8px; border:1px solid #eee;" 
              onerror="this.style.display='none';">
          </td>
          <td data-label="ชื่อ">
            <input value="${menu.name}" id="name_${menu.id}" oninput="handleEditMenu('${menu.id}')" onchange="handleEditMenu('${menu.id}')">
          </td>
          <td data-label="ราคา">
            <input type="number" value="${menu.price}" id="price_${menu.id}" style="width:80px" oninput="handleEditMenu('${menu.id}')" onchange="handleEditMenu('${menu.id}')">
          </td>
          <td data-label="รายละเอียด">
            <input value="${menu.description || ''}" id="desc_${menu.id}" oninput="handleEditMenu('${menu.id}')" onchange="handleEditMenu('${menu.id}')">
          </td>
          <td data-label="จัดการ">
            <button class="delete-btn" onclick="deleteMenu('${menu.id}')" title="ลบ">delete</button>
          </td>
        </tr>`;
      });
      html += "</table>";
      html += `<div style="text-align:center; margin-top:28px;">
        <button class="save-btn" onclick="saveAllEdits()">Save</button>
      </div>`;
      document.getElementById('menuList').innerHTML = html;
    }

    // DEBUG: จับการเปลี่ยนไฟล์
    document.getElementById('image').addEventListener('change', function() {
      alert("เลือกไฟล์รูปแล้ว! files.length=" + this.files.length);
      console.log("เลือกไฟล์รูปแล้ว:", this.files);
    });

    // DEBUG: จับ submit
    document.getElementById('addMenuForm').addEventListener('submit', function(e) {
      alert("Form กำลังจะ submit!");
      console.log("Form submit event เรียกใช้งานแล้ว");
    });

    // แก้ไขฟังก์ชัน submit ใหม่
    document.getElementById('addMenuForm').onsubmit = async function(e) {
      e.preventDefault();

      try {
        const formData = new FormData();
        formData.append('name', document.getElementById('name').value);
        formData.append('price', document.getElementById('price').value);
        formData.append('description', document.getElementById('description').value);
        
        if (document.getElementById('image').files[0]) {
          formData.append('image', document.getElementById('image').files[0]);
          alert("เพิ่มไฟล์รูปใน FormData แล้ว");
        } else {
          alert("ไม่ได้แนบรูป (หรือไม่ได้เลือก)");
        }

        alert("กำลังส่งข้อมูลไปยัง backend: " + baseURL + "/menu/add");

        const response = await fetch(baseURL + "/menu/add", {
          method: "POST",
          body: formData
        });

        alert("fetch ส่งข้อมูลไปแล้ว status=" + response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error("HTTP " + response.status + ": " + errorText);
        }

        const data = await response.json();
        alert("เพิ่มเมนูเสร็จเรียบร้อย data=" + JSON.stringify(data));
        this.reset();
        clearMenuCache();
        loadMenus(true);
      } catch (err) {
        alert("เกิด error ระหว่างเพิ่มเมนู: " + err.message);
        console.log("error:", err);
      }
    };

    function deleteMenu(id) {
      if (!confirm("ลบเมนูนี้จริงหรือ?")) return;
      fetch(baseURL + "/menu/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: id })
      }).then(res => res.json())
        .then((data) => {
          clearMenuCache();
          loadMenus(true);
        })
        .catch((err) => {
          alert("เกิด error ระหว่างลบ: " + err.message);
        });
    }

    // เคลียร์ cache ครั้งแรก
    try {
      if (!sessionStorage.getItem('clearedOnce')) {
        localStorage.clear();
        sessionStorage.clear();
        sessionStorage.setItem('clearedOnce', '1');
        location.reload();
      }
    } catch (e) {
      alert("Error ใช้งาน sessionStorage/localStorage: " + e.message);
    }

    loadMenus();
  </script>
</body>
</html>