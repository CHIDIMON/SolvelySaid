<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>เมนูอาหาร (Admin)</title>
  <link rel="stylesheet" href="db.css">
</head>
<body>
  <div class="container">
    <h2>จัดการเมนูอาหาร</h2>
    <form id="addMenuForm">
      <input type="text" id="name" placeholder="ชื่อเมนู" required>
      <input type="number" id="price" placeholder="ราคา" required>
      <textarea id="description" placeholder="รายละเอียดเมนู"></textarea>
      <button type="submit">เพิ่มเมนู</button>
    </form>
    <hr>
    <h3>
      รายการเมนูทั้งหมด
      <button type="button" onclick="loadMenus()" class="refresh-btn">รีเฟรช</button>
    </h3>
    <div id="menuList"></div>
  </div>

  <script>
    const defaultURL = "https://app.solvelysaid.space";
    const fallbackURL = "https://solvelysaidbn.onrender.com";
    let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;

    // โหลดเมนูทั้งหมด (ใช้ fallback อัตโนมัติ)
    function loadMenus() {
      fetch(baseURL + "/debug/menus")
        .then(res => {
          if (!res.ok) throw new Error("Fetch failed");
          return res.json();
        })
        .then(data => {
          if (data.menus) renderMenus(data.menus);
          else document.getElementById('menuList').innerHTML = "ไม่พบเมนู";
        })
        .catch(err => {
          // fallback ถ้า defaultURL ล่ม
          if (baseURL !== fallbackURL) {
            baseURL = fallbackURL;
            sessionStorage.setItem("workingBaseURL", baseURL);
            loadMenus(); // ลองใหม่
          } else {
            alert("ติดต่อ server ไม่ได้ กรุณาตรวจสอบ backend!");
          }
        });
    }

    // แสดงรายการเมนู + ปุ่มแก้ไข/ลบ
    function renderMenus(menus) {
      let html = '<table><tr><th>ชื่อ</th><th>ราคา</th><th>รายละเอียด</th><th>จัดการ</th></tr>';
      menus.forEach(menu => {
        html += `<tr>
          <td><input value="${menu.name}" id="name_${menu.id}"></td>
          <td><input type="number" value="${menu.price}" id="price_${menu.id}" style="width:60px"></td>
          <td><input value="${menu.description || ''}" id="desc_${menu.id}"></td>
          <td>
            <button onclick="editMenu('${menu.id}')">บันทึก</button>
            <button class="danger" onclick="deleteMenu('${menu.id}')">ลบ</button>
          </td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById('menuList').innerHTML = html;
    }

    // เพิ่มเมนูใหม่
    document.getElementById('addMenuForm').onsubmit = function(e) {
      e.preventDefault();
      fetch(baseURL + "/menu/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: document.getElementById('name').value,
          price: document.getElementById('price').value,
          description: document.getElementById('description').value,
        })
      }).then(res => res.json())
        .then(() => {
          this.reset();
          loadMenus();
        });
    };

    // แก้ไขเมนู
    function editMenu(id) {
      fetch(baseURL + "/menu/edit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: id,
          name: document.getElementById("name_" + id).value,
          price: document.getElementById("price_" + id).value,
          description: document.getElementById("desc_" + id).value,
        })
      }).then(res => res.json()).then(loadMenus);
    }

    // ลบเมนู
    function deleteMenu(id) {
      if (!confirm("ลบเมนูนี้จริงหรือ?")) return;
      fetch(baseURL + "/menu/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: id })
      }).then(res => res.json()).then(loadMenus);
    }

    loadMenus();
  </script>
</body>
</html>
