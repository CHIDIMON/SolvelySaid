<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>เมนูอาหาร (Admin)</title>
  <link rel="stylesheet" href="db.css">
</head>
<body>
  <div class="container">
    <h2>จัดการเมนูอาหาร</h2>
    <form id="addMenuForm">
      <input type="text" id="name" placeholder="ชื่อเมนู" required>
      <input type="number" id="price" placeholder="ราคา" required>
      <textarea id="description" placeholder="รายละเอียดเมนู"></textarea>
      <button type="submit">เพิ่มเมนู</button>
    </form>
    <hr>
    <h3>
      รายการเมนูทั้งหมด
      <button type="button" onclick="refreshMenus()" class="refresh-btn">รีเฟรช</button>
    </h3>
    <div id="menuList"></div>
  </div>

  <!-- วาง block นี้ไว้บนสุดของ script -->
  <script>
    if (!sessionStorage.getItem('clearedOnce')) {
      localStorage.clear();
      sessionStorage.clear();
      sessionStorage.setItem('clearedOnce', '1');
      location.reload();
    }
  </script>
  
  <script>
    const defaultURL = "https://app.solvelysaid.space";
    const fallbackURL = "https://solvelysaidbn.onrender.com";
    let baseURL = sessionStorage.getItem("workingBaseURL") || defaultURL;
    let editedMenus = {};

    // -- caching function --
    function cacheMenus(menus) {
      localStorage.setItem('menu_cache', JSON.stringify(menus));
    }
    function getCachedMenus() {
      const cache = localStorage.getItem('menu_cache');
      if (cache) {
        try { return JSON.parse(cache); } catch (e) {}
      }
      return null;
    }
    function clearMenuCache() {
      localStorage.removeItem('menu_cache');
    }

    function loadMenus(requestFresh = false) {
      if (!requestFresh) {
        const cached = getCachedMenus();
        if (cached && Array.isArray(cached)) {
          renderMenus(cached);
          return;
        }
      }
      fetch(baseURL + "/debug/menus")
        .then(res => {
          if (!res.ok) throw new Error("Fetch failed");
          return res.json();
        })
        .then(data => {
          if (data.menus) {
            cacheMenus(data.menus);
            renderMenus(data.menus);
          } else {
            document.getElementById('menuList').innerHTML = "ไม่พบเมนู";
          }
          editedMenus = {};
        })
        .catch(err => {
          if (baseURL !== fallbackURL) {
            baseURL = fallbackURL;
            sessionStorage.setItem("workingBaseURL", baseURL);
            loadMenus(true);
          } else {
            alert("ติดต่อ server ไม่ได้ กรุณาตรวจสอบ backend!");
          }
        });
    }

    function refreshMenus() {
      clearMenuCache();
      location.reload();
    }

    function saveAllEdits() {
      const editedArray = Object.values(editedMenus);
      if (!editedArray.length) {
        alert('ไม่มีข้อมูลที่แก้ไข');
        return;
      }
      fetch(baseURL + "/menu/edit/batch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ menus: editedArray })
      })
      .then(res => res.json())
      .then(data => {
        editedMenus = {};
        clearMenuCache();
        loadMenus(true);
      })
      .catch(() => alert("เกิดข้อผิดพลาดในการบันทึก"));
    }

    function handleEditMenu(id) {
      const name = document.getElementById('name_' + id).value;
      const price = document.getElementById('price_' + id).value;
      const description = document.getElementById('desc_' + id).value;
      editedMenus[id] = { id, name, price, description };
    }

    // ====== ส่วนนี้คือจุดที่ "แก้ไข" ให้รองรับ data-label ======
    function renderMenus(menus) {
      let html = '<table><tr><th>รูป</th><th>ชื่อ</th><th>ราคา</th><th>รายละเอียด</th><th>จัดการ</th></tr>';
      menus.forEach(menu => {
        let imgUrl = baseURL + "/image/thumb/" + encodeURIComponent(menu.name);
        html += `<tr>
          <td data-label="รูป">
            <img src="${imgUrl}" alt="img" style="width:55px; height:55px; object-fit:cover; border-radius:8px; border:1px solid #eee;" 
              onerror="this.src='https://via.placeholder.com/55x55?text=No+Img';">
          </td>
          <td data-label="ชื่อ">
            <input value="${menu.name}" id="name_${menu.id}" oninput="handleEditMenu('${menu.id}')" onchange="handleEditMenu('${menu.id}')">
          </td>
          <td data-label="ราคา">
            <input type="number" value="${menu.price}" id="price_${menu.id}" style="width:80px" oninput="handleEditMenu('${menu.id}')" onchange="handleEditMenu('${menu.id}')">
          </td>
          <td data-label="รายละเอียด">
            <input value="${menu.description || ''}" id="desc_${menu.id}" oninput="handleEditMenu('${menu.id}')" onchange="handleEditMenu('${menu.id}')">
          </td>
          <td data-label="จัดการ">
            <button class="delete-btn" onclick="deleteMenu('${menu.id}')" title="ลบ">delete</button>
          </td>
        </tr>`;
      });
      html += "</table>";
      html += `<div style="text-align:center; margin-top:28px;">
        <button class="save-btn" onclick="saveAllEdits()">Save</button>
      </div>`;
      document.getElementById('menuList').innerHTML = html;
    }
    // ====== จบจุดที่ต้องแก้ไข ======

    document.getElementById('addMenuForm').onsubmit = function(e) {
      e.preventDefault();
      fetch(baseURL + "/menu/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: document.getElementById('name').value,
          price: document.getElementById('price').value,
          description: document.getElementById('description').value,
        })
      }).then(res => res.json())
        .then(() => {
          this.reset();
          clearMenuCache();
          loadMenus(true);
        });
    };

    function deleteMenu(id) {
      if (!confirm("ลบเมนูนี้จริงหรือ?")) return;
      fetch(baseURL + "/menu/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: id })
      }).then(res => res.json())
        .then(() => {
          clearMenuCache();
          loadMenus(true);
        });
    }

    loadMenus();
  </script>
</body>
</html>
